-- database: c:\Users\joshu\Documents\rust_projects\deadball_league_generator\deadball.db

-- Use the â–· button in the top right corner to run the entire file.

WITH pd_info AS(
    SELECT 
        leagues.id AS league_id, 
        FLOOR(AVG(players.pd_int)) as avg_pd FROM leagues
    INNER JOIN teams on teams.league_id = leagues.id
    INNER JOIN players on players.team_id = teams.id
    GROUP BY leagues.id
)

SELECT 
    leagues.league_name, 
    leagues.era,
    leagues.gender,
    COUNT(DISTINCT teams.id) AS number_of_teams,
    COUNT(DISTINCT players.id) AS number_of_players,
    FLOOR(AVG(players.bt)) AS avg_bt, 
    FLOOR(AVG(players.obt)) AS avg_obt,
    pd_info.avg_pd AS avg_pd, 
    FLOOR(AVG(teams.team_score)) AS avg_team_score
FROM
    leagues
INNER JOIN teams ON teams.league_id = leagues.id
INNER JOIN players on players.team_id = teams.id
INNER JOIN pd_info ON pd_info.league_id = leagues.id
GROUP BY leagues.league_name
ORDER BY number_of_teams DESC, avg_team_score DESC, avg_pd DESC,avg_obt DESC, avg_bt DESC;