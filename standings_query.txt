-- database: c:\Users\joshu\Documents\rust_projects\deadball_league_generator\deadball.db

-- Use the â–· button in the top right corner to run the entire file.
WITH loser_table AS(
    SELECT teams.id AS team_id,teams.team_name,COUNT(games.games_id) as losses
    FROM teams
    INNER JOIN games ON (games.home_team_id = teams.id OR games.away_team_id = teams.id)
    AND games.winner_id != teams.id
    GROUP BY teams.team_name
)


SELECT 
    teams.team_name, 
    COUNT(games.games_id) AS wins,
    MAX(wins) - teams.wins AS games_behind, 
    loser_table.losses FROM teams
INNER JOIN 
    games ON games.winner_id = teams.id
INNER JOIN 
    loser_table ON loser_table.team_id = teams.id
GROUP BY 
    teams.team_name
ORDER BY 
    games_behind DESC;